# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Trust is a risk-managed algorithmic trading system in Rust. It enforces risk management rules automatically before capital is committed, manages the complete trade lifecycle, and integrates with the Alpaca broker API. Data is persisted in SQLite via Diesel ORM.

## Development Commands

```bash
make build              # Setup DB + debug build
make test               # Run all tests
make test-single        # Single-threaded tests (required for DB tests)
make fmt                # Auto-format code
make lint               # Clippy with -D warnings
make ci-fast            # Quick checks (fmt + clippy)
make ci                 # Full CI pipeline (fmt, clippy, build, tests, snapshots, perf)
make pre-commit         # Pre-commit checks (fmt + strict lint + single-threaded tests)
make pre-push           # Full pre-push validation (quality gate + CI)
```

```bash
# Individual crates
cargo build -p trust-model
cargo test -p core
cargo test -p cli -- --test-threads=1    # CLI tests must be single-threaded
cargo test -p cli --test integration_test_trade -- test_name  # Run specific test
```

```bash
# Database management
make setup              # Initial diesel setup
make migration NAME=x   # Create new migration in db-sqlite/migrations/
make clean-db           # Redo all migrations
make delete-db          # Delete ~/.trust/debug.db
```

```bash
# Snapshots and performance
make ci-snapshots       # Verify CLI report JSON snapshots
make snapshots-update   # Regenerate snapshots (UPDATE_SNAPSHOTS=1)
make ci-perf            # Performance regression gate
```

## Architecture

Six-crate workspace following clean architecture with trait-based abstraction:

```
CLI (binary, Clap)
 └─► Core (TrustFacade - single entry point for all business logic)
      ├─► Model (domain types + Broker/DatabaseFactory traits)
      ├─► DB-SQLite (Diesel ORM, implements DatabaseFactory)
      ├─► Alpaca-Broker (implements Broker trait)
      └─► Broker-Sync (actor-based WebSocket sync for live trade sessions)
```

### Crate Responsibilities

- **model** (`trust-model`): Domain types (Account, Trade, Order, Transaction, Rule, Level, Execution, etc.) and trait definitions (`Broker`, `DatabaseFactory`). Enforces `#![deny(float_arithmetic)]` — all monetary values use `rust_decimal::Decimal`.
- **core**: Business logic via `TrustFacade` (~1800 lines). Contains calculators (risk, performance, concentration, drawdown), validators (funding, trade, transaction, rule), services (leveling, distribution, grading, advisory), and commands (trade lifecycle, transactions, orders).
- **db-sqlite**: `SqliteDatabase` implementing `DatabaseFactory`. Uses Diesel with 14+ migrations. Schema in `db-sqlite/src/schema.rs` (auto-generated). Includes backup/import functionality.
- **cli**: Clap-based CLI. `dispatcher.rs` is the central routing file (~184KB). Commands in `cli/src/commands/`, views in `cli/src/views/`, interactive prompts in `cli/src/dialogs/`.
- **alpaca-broker**: `AlpacaBroker` implementing the `Broker` trait. Handles order submission, sync, close, cancel, stop/target modification, market data, and execution fetching. API keys stored in system keychain.
- **broker-sync**: Actor-based real-time sync via `BrokerSync`/`BrokerSyncHandle`. Commands (StartTradeSession, StopTradeSession, Shutdown) and events (TradeSessionSnapshot, etc.) for WebSocket-based state management.

### Key Patterns

- **Facade**: `TrustFacade` is the single API surface for all operations. CLI never calls DB or broker directly.
- **DatabaseFactory**: Returns specialized read/write trait objects (e.g., `AccountRead`, `OrderWrite`, `ReadTradeDB`). Uses named savepoints for transaction atomicity.
- **Trade State Machine**: Draft → Funded → Submitted → Filled → Closed (ClosedTarget/ClosedStopLoss) or Canceled at any stage.
- **Three-Order System**: Every trade has entry, stop-loss, and target orders.
- **Risk Validation Flow**: `CLI → Core Validators → DB Check → Broker API → DB Update`. Validation happens before capital is committed.
- **Event-Driven**: Trade close events trigger leveling evaluation, profit distribution, and grading.
- **Protected Mode**: `TrustFacade.enable_protected_mode()` + Argon2 password authorization for critical mutations.
- **Level System**: Account progression system with configurable adjustment rules, cached evaluations.

### Database

- SQLite at `~/.trust/debug.db` (configurable)
- Schema auto-generated by Diesel in `db-sqlite/src/schema.rs` — never edit manually
- Migrations in `db-sqlite/migrations/` (up.sql/down.sql pairs)
- Key tables: accounts (with hierarchy), accounts_balances (multi-currency), trades, orders, transactions, executions, levels, level_changes, distribution_rules, distribution_history, broker_logs, trading_vehicles, rules, trade_grades

### Testing

- **Integration tests** in `cli/tests/` (18 test files). Must run single-threaded (`--test-threads=1`) due to shared SQLite access.
- **Core tests** in `core/src/integration_tests.rs` with mock implementations in `core/src/mocks.rs`.
- **DB tests** in `db-sqlite/src/migration_fk_safety_tests.rs` for foreign key constraint validation.
- **Snapshot tests**: JSON contract tests for CLI reports. Update with `make snapshots-update`.
- **Perf gate**: `make ci-perf` runs regression guard on sync lifecycle.

## Modifying Key Areas

- **Risk validation**: `core/src/validators/`
- **Trade calculations**: `core/src/calculators_trade/`
- **Trade lifecycle commands**: `core/src/commands/trade.rs`
- **CLI command routing**: `cli/src/dispatcher.rs`
- **CLI command definitions**: `cli/src/commands/`
- **Database queries**: `db-sqlite/src/database.rs`
- **Broker integration**: `alpaca-broker/src/` (each operation in its own module)
- **Domain model changes**: Start in `model/src/`, then update `db-sqlite` schema + migrations, then `core` logic
